<?php if (substr($_SERVER['SCRIPT_FILENAME'],-10) !='cj_adm.php') { die('Access denied.'); } switch($_POST['cmd']) { case 'Delete': f_30($_POST['bf']); f_31(); break; case 'Create': f_32(); f_31(); break; case 'Restore': f_29($_POST['bf']); f_31(); break; default: f_31(); } function f_29($v_1) { if ($v_1) { $v_11=fopen('./sys_log/cj_backup.'.$v_1,'r'); while ($v_19 = fgetcsv ($v_11, 10000, ",")) { if (substr($v_19[0],0,7)=='#TABLE ') { $v_21=mysql_query("delete from ".substr($v_19[0],7)); $v_59="INSERT INTO ".substr($v_19[0],7); unset($v_19[0]); $v_59.=' ('.implode(',',$v_19).') '; }else { if ($v_19[0] !='') { $v_60=$v_59.'VALUES (\''.implode("','",$v_19).'\')'; mysql_query($v_60); } } } fclose($v_11); f_19('Backup restored <br>('.$v_1.')','ok',false); print '<br>'; } } function f_30($v_1) { @unlink('./sys_log/cj_backup.'.$v_1); f_19($v_1.' deleted','ok',false); } function f_31() { $v_18=opendir('./sys_log'); $v_61=array(); while (($v_1 = readdir($v_18)) !== false) { if (substr($v_1,0,10) == 'cj_backup.') { $v_61[]=substr($v_1,10); } } closedir($v_18); krsort($v_61); ?> <table width="400" border="0" cellspacing="1" cellpadding="1" align="center" style="border: 1px solid #4B0082;"> <form action="?module=backup" method="post"> <tr><td colspan="2" align="center" class="tblRTitle">CJ Backup</td></tr> <?php while (list($v_9,$v_10) = each($v_61)) { ?> <tr> <td class="tblRNormal" width="50" align="center"><input type="radio" name="bf" value="<?php print $v_10?>"></td> <td class="tblRNormal" width="350"><a href="./sys_log/cj_backup.<?php print $v_10?>"><?php print $v_10?></a></td> </tr> <?php } ?> <tr><td colspan="2" align="center" class="tblRNormal"><input type="submit" name="cmd" value="Create" class="submit"> <input type="submit" name="cmd" value="Restore" class="submit"> <input type="submit" name="cmd" value="Delete" class="submit"></td></tr> </table> <? } function f_32() { $v_62=array('tm_cj_banned','tm_cj_cron','tm_cj_dburl','tm_cj_force','tm_cj_group','tm_cj_hour','tm_cj_stats','tm_cj_traders','tm_cj_tmpst'); $v_50=''; while(list($v_9,$v_10)=each($v_62)) { $v_50.='"#TABLE '.$v_10.'"'; $v_21=mysql_list_fields(DB_DEVICE,$v_10); $v_63 = mysql_num_fields($v_21); for ($v_16=0;$v_16<$v_63;$v_16++) { $v_50.=',"'.mysql_field_name($v_21, $v_16).'"'; } $v_50.="\n"; $v_50.=f_33($v_10); $v_50.="\n"; } $v_11=fopen('./sys_log/cj_backup.'.date("Y-m-d").'.csv','w'); fwrite($v_11,$v_50); fclose($v_11); f_19('Backup created <br>('.date("Y-m-d").'.csv)','ok',false); print '<br>'; } function f_33($v_64) { $v_22=''; $v_21=mysql_query("select * from ".$v_64) or print mysql_error(); while($v_30=mysql_fetch_row($v_21)) { $v_22.='"'.implode('","',$v_30).'"'."\n"; } return $v_22; } ?> 