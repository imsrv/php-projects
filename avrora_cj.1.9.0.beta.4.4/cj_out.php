<?php include('./cj_config.php'); mysql_connect(DB_HOST,DB_LOGIN,DB_PASS) or die('Cannot connect to DB'); mysql_select_db(DB_DEVICE) or die('Cannot select DB DEVICE'); $_GET['p']=(false==isset($_GET['p']))?DEF_P:intval($_GET['p']); $_GET['gr']=(intval($_GET['gr'])<1)?'262143':intval($_GET['gr']); $_COOKIE['TM_CJ_TID']=(intval($_COOKIE['TM_CJ_TID']) < 1)?'4':intval($_COOKIE['TM_CJ_TID']); $GLOBALS['click']=-1; function f_39() { $v_11 = fopen('./.htaccess','a'); if ($v_11) { fwrite($v_11,"deny from ".$_SERVER['REMOTE_ADDR']."\n"); fclose($v_11); } $v_11 = fopen('./sys_log/banned.ip.csv','a'); if ($v_11) { fwrite($v_11,"\"".date("Y-m-d H:i:s")."\";\"".$_COOKIE['TM_CJ_TID']."\";\"".$_SERVER['REMOTE_ADDR']."\";\"".$_SERVER['HTTP_USER_AGENT']."\";\"".$_SERVER['HTTP_REFERER']."\"\n"); fclose($v_11); } } function f_40() { $v_21=mysql_query("select * from tm_cj_dburl order by url asc"); $v_39=array(); $v_74=intval($_COOKIE['TM_CJ_DBURL']); while ($v_50=mysql_fetch_assoc($v_21)) { $v_39[]=$v_50["url"]; } if ($v_74 < 0 || $v_74+1 >= mysql_num_rows($v_21)) { $v_75=0; }else { $v_75=$v_74+1; } setcookie ('TM_CJ_DBURL', $v_75,time()+(86400*32),'/'); return $v_39[$v_75]; } function f_41($v_76) { $v_14=unserialize(@implode('',@file('./thumb/thumb.stats'))); if (!is_array($v_14)) { $v_14=array();} $v_5=array(); $v_7=fopen('./thumb/thumb.csv','r'); while ($v_8 = fgetcsv ($v_7, 1000, ";")) { $v_5[$v_8[1]]=trim($v_8[0]); } fclose($v_7); if ($v_5[$v_76]) { $v_14[$v_76]++; if ($v_11=@fopen('./thumb/thumb.stats','w')) { flock($v_11,2); fwrite($v_11,serialize($v_14)); flock($v_11,3); fclose($v_11); } } } function f_42() { list($v_77, $v_78) = explode(' ', microtime()); return (float) $v_78 + ((float) $v_77 * 100000); } function f_43() { srand(f_42()); $v_79 = rand(0,100); return $v_79; } function f_44() { if ($_GET['dburl']) { return array( 'tid' => '2', 'domain' => 'gallery', 'url' => f_40() ); }elseif ($_GET['url']) { return array( 'tid' => '2', 'domain' => 'gallery', 'url' => $_GET['url'] ); }else { return f_48('exout'); } } function f_45() { if (intval($_GET['fk']) > 0 && intval($_GET['fk']) > $GLOBALS['click']) { return true; }else { return false; } } function f_46() { $v_80=mysql_query("select tid, _time, _act from tm_cj_iplog where _ip=".crc32($_SERVER['REMOTE_ADDR'])); $v_81=array();$v_82=1;$v_83=0;$GLOBALS['click']=0; while($v_30=mysql_fetch_array($v_80)) { $v_81[]=$v_30['tid']; if ($v_30['_act']==1 && $v_82 < $v_30['_time']) { $v_83=$v_30['tid']; $v_82=$v_30['time']; }elseif($v_30['_act']=='2') { $GLOBALS['click']++; } } if ($_COOKIE['TM_CJ_TID'] == 4 && $v_83 > 0) { $_COOKIE['TM_CJ_TID']=$v_83; } return $v_81; } function f_47(&$v_84) { $v_85=(IGNORE_BACK_PRD == 1)?'':'having my_back <= back'; $v_86="select st.tid, tr._url, tr._domain, tr._back as back ,if (st._hout+tmp._out > 0,((st._hclk+tmp._clk)*100)/(st._hout+tmp._out),100)+if (st._hout-tmp._force < 0,".FORCE_PRIO."-st._hout/100,0) as _prio ,if (st._hout+tmp._out > 0,((st._hclk+tmp._clk)*100)/(st._hout+tmp._out),100) as _trader_kpd ,if (st._hout-tmp._force < 0,100,((st._hout+tmp._out)*100)/(st._huin+tmp._uin)) as my_back ,st._hout ,tmp._force from tm_cj_stats st, tm_cj_tmpst tmp, tm_cj_traders tr where st.tid=tmp.tid and st.tid=tr.tid and tr._status='on' and st.tid > 4 and ".intval($_GET['gr'])." & tr._egid > 0 ".$v_85." order by _prio desc, _trader_kpd desc, my_back asc"; $v_87=mysql_query($v_86); while($v_22=mysql_fetch_array($v_87)) { if (!in_array($v_22['tid'],$v_84)) { $v_88['tid']=$v_22['tid']; $v_88['url']=$v_22['_url']; $v_88['domain']=$v_22['_domain']; break; } } if (!$v_88) { if ($_GET['url'] || $_GET['dburl']) { $v_88=f_44(); }else { $v_88=f_48('exout'); } } return $v_88; } function f_48($v_32) { $v_21=mysql_query("select tid as tid, _url as url, _domain as domain from tm_cj_traders where _domain='".$v_32."'"); if (mysql_num_rows($v_21) == 1) { return mysql_fetch_array($v_21); }else { $v_21=mysql_query("select tid, _url as url, _domain as domain from tm_cj_traders where tid=3"); return mysql_fetch_array($v_21); } } function f_49($v_89,$v_83) { if ($GLOBALS['click'] == -1) { $v_21=mysql_query("select count(tid) as _count from tm_cj_iplog where _act=2 and _ip=".crc32($_SERVER['REMOTE_ADDR'])); $GLOBALS['click'] = mysql_result($v_21,0,'_count'); } if ($GLOBALS['click'] <= MAX_CLICK) { mysql_query("update tm_cj_stats set _clk=_clk+1, _hclk=_hclk+1 where tid=".intval($v_83)); if (mysql_affected_rows() == 0) { mysql_query("update tm_cj_stats set _clk=_clk+1, _hclk=_hclk+1 where tid=4"); } } mysql_query("update tm_cj_stats set _out=_out+1, _hout=_hout+1 where tid=".intval($v_89)); mysql_query("insert into tm_cj_iplog(_ip, tid, _time, _act) values('".crc32($_SERVER['REMOTE_ADDR'])."','".$v_89."','".time()."','2')"); return true; } if ($_GET['thumb']) { f_41($_GET['thumb']); } if (trim($_GET['acc']) != '') { f_39(); mysql_close(); die('IP Banned'); } $v_84=&f_46(); $v_90 = f_43(); if ($_COOKIE['TM_CJ_TID'] == 4) { $v_81=f_48('nocookie'); }else { if (intval($_GET['fk']) > 0 && f_45()) { $v_81=f_44(); }elseif($v_90 <= intval($_GET['p']) && ($_GET['url'] || $_GET['dburl'])) { $v_81=f_44(); }elseif($_GET['tr']) { $v_81=f_48($_GET['tr']); }else { $v_81=f_47($v_84); } } f_49($v_81['tid'],$_COOKIE['TM_CJ_TID']); mysql_close(); Header("Cache-Control: no-cashe, must-revalidate"); Header("Pragma: no-cache"); header('Location: '.$v_81['url']); ?>